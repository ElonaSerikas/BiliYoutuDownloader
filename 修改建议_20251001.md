1) 架构体检（问题 → 修复）

① 主进程安全与可维护性

现状：建议确保 contextIsolation: true、nodeIntegration: false，仅通过 preload 暴露白名单 API；IPC channel 需命名空间化，避免泄露任意执行面。

修复：见下方 src/main/main.ts 与 src/main/preload.ts 补丁；统一以 app: 前缀区分通道；主进程用 ipcMain.handle + 返回显式错误码，前端用 invoke。

② FFmpeg 依赖与平台适配

现状：有启动前检查脚本 scripts/ffmpeg-guard.ts；建议把结果写入 process.env.FFMPEG_PATH 并在主进程 app.whenReady() 之后设置到下载器。

修复：在 main.ts 注入到 DownloadManager 构造参数；增加“缺失时的友好引导（打开官网/自动下载）”。

③ Download 内核（分片+续传+合并）

典型坑：

分片边界错位导致合并花屏/音画错位；

ETag/Last-Modified 不校验导致断点续传失败或 416；

Range 重试无退避策略；

合并写入无流式/大内存峰值。

修复要点：

元数据快照：保存 url, size, etag, lastModified, chunkSize, chunks[n].doneOffset 到 Electron-Store；

续传：基于 doneOffset 继续 Range: bytes=start-；

合并：边下边顺序写入 .part，完成后原子重命名；

重试：指数退避 2^k * jitter，含可重试状态码（408/429/5xx）与网络异常。

见 DownloadManager.ts 与 segmentWorker.ts 实现片段。

④ YouTube 与 B站解析抽象

现状：services/extractors/* 已分层；建议定义统一 ExtractorResult（媒体流/弹幕/封面/评论可选）和 selectProfile（画质/编码）方法，前端一套 UI 适配两站点。

修复：在 types.ts 增补类型，在 bilibili.ts/youtube.ts 返回一致结构。

⑤ 弹幕/ASS 清晰度

现状：有 bili-danmaku.ts 与 ass.ts；为了“高刷新率/边缘清晰 + 字体可调”，把字号/描边/阴影作为参数并暴露到设置页；ASS 生成保持 \bord\shad\alpha 控制。

修复：见 ass.ts 参数化 + Settings.tsx 控制项。

⑥ 日志系统

现状：建议分级日志（INFO/WARN/ERROR）+ 旋转文件 + 前端“导出日志”。

修复：在 main/services/logger.ts 引入 pino（或 electron-log），同时在 renderer 通过 IPC 订阅最新 200 条用于“诊断面板”。

⑦ 任务队列与并发

现状：需要前端可视并发度调节（1–10），与队列状态（待下载/下载中/已完成）。

修复：DownloadManager 维护“最大并发 + FIFO 队列”；renderer 设置页面提供 Slider。队列状态通过 app:task:progress/app:task:state 广播。

2) Fluent Design：现代扁平化 + Acrylic/Mica + 自定义标题栏

设计目标（与你的规格一致）：左侧可折叠侧边栏、全局浅/深色切换、Acrylic 背景/遮罩、Windows 11 风格标题栏、过渡与阴影细节。

软件要求

技术路线

采用 @fluentui/react-components v9（新版 Fluent UI），搭配自定义 CSS 变量实现扁平化（更直角、更低饱和阴影）。

Electron 窗口启用 Windows 11 Mica/Acrylic。Windows 可用 BrowserWindow 的 backgroundMaterial: 'mica'|'acrylic'（Electron 28+），旧版可选 electron-acrylic-window。macOS 用 vibrancy: 'sidebar'。

标题栏用 -webkit-app-region: drag 区域拖拽，按钮区域 no-drag。

背景图/遮罩：CSS backdrop-filter: blur() + 可调透明度。




一、架构和代码审查
1. 架构总结（无重大错误）
项目架构清晰，采用了标准的 Electron 架构：主进程 (Main Process) 负责系统级操作和核心业务逻辑（如文件 I/O、下载管理、IPC 路由），渲染进程 (Renderer Process) 负责用户界面（React + Fluent UI）。

IPC 通信：通过 src/main/ipc/index.ts 集中管理 ipcMain.handle 路由，前端通过 preload.js 暴露的 window.api.invoke 调用。

下载核心：DownloadManager.ts 在主进程，通过 worker_threads 调用 segmentWorker.ts 实现多线程分片下载，符合需求中对性能和断点续传的要求。

登录与存储：使用 electron-store 进行加密存储配置和 Cookie，登录通过新开 BrowserWindow 捕获 Cookie，合规且安全。

扩展功能：已实现 B 站/YouTube 解析、弹幕导出（XML/ASS）、评论导出、直播信息获取和诊断工具，功能覆盖度高。

2. 潜在 Bug 和完善建议
文件	问题/建议	完善方向
src/main/service/downloader/DownloadManager.ts	缺少速度计算：任务进度 (progress) 结构体中包含 speed 字段，但在 run 方法中，worker 传递的 msg.data 并没有计算速度。	在 segmentWorker.ts 中实现速度计算，并随 progress 消息返回，或者在 DownloadManager.ts 中基于时间戳和下载量计算速度。
src/main/service/downloader/workers/segmentWorker.ts	错误处理简化：worker 进程中的错误只通过 msg('error', ...) 返回，没有统一的错误码体系，与需求中的“错误码+原因建议”不完全匹配。	整合 src/common/eventBus.js 中的错误类型，确保 worker 抛出的错误可以被主进程/前端捕获并带有明确的错误码。
src/renderer/pages/SearchPage.tsx	音视频合并：用户在 SearchPage 只能选择一个媒体流（video 或 audio）并添加到下载，但 B 站高画质视频是音视频分离的。	在 SearchPage.tsx 中增加逻辑，允许用户选择一个视频流和一个音频流，然后合并为一个任务 payload 传递给 task:create。
src/main/service/auth/login.ts	登录 Cookie 完整性：B 站登录逻辑只检查了 SESSDATA，YouTube 检查了 SID。YouTube/Google 的 Cookie 可能很复杂，最好将完整 Cookie 字符串存下来。	已实现 Cookie 完整字符串存储。

导出到 Google 表格
二、功能完善建议
根据需求规格说明书，以下功能需要进一步落实：

1. 界面与交互定制（Fluent Design 落实）
自定义背景图与亚克力效果：src/renderer/components/MainLayout.tsx 已实现自定义背景图、背景遮罩层和亚克力效果的开关与参数调整（enableAcrylic, backgroundOpacity），基本满足 Fluent Design 的外观需求。

优雅动画：目前组件交互（如导航、按钮）没有明显的动画代码（如 CSS transition 或 React 动画库）。需要额外引入 framer-motion 或 Fluent UI 推荐的动画库来实现“平滑动画”和“滑动/淡入过渡动画”。

自定义标题栏：src/renderer/components/CustomTitleBar.tsx 已实现自定义标题栏，并使用了 WebkitAppRegion: 'drag' 来拖拽窗口，符合需求。

2. 核心功能待办
需求功能	现状分析	完善要点
文件大小预估	bilibili.ts 和 youtube.ts 都没有返回文件大小预估值，ytdl-core 的 sizeEstimate 可用，但 B 站需要额外 API 请求或估算。	在解析器中增加文件大小估算（StreamInfo 增加 sizeEstimate 字段），并在 SearchPage 渲染。
合集/收藏夹批量下载	主进程有 bili-batch.ts，提供了 收藏夹和合集解析 的 API，但前端（SearchPage.tsx）尚未实现相关的 UI 和调用逻辑。	在 SearchPage 或新增页面中实现一个批量输入框或列表，调用 planBatchByFavorite/planBatchBySeries，并将解析出的多个任务分发到 task:create。
UP主简介/视频评论导出	评论区导出功能已实现（bili-comments.ts, youtube-comments.ts），但 UP主简介 导出逻辑缺失。	完善 bili-space.ts，增加导出 UP 主简介和头像的功能，并在任务创建时加入选项。
文件命名规则	仅在 electron-store 的默认设置中有 filenameTpl: '{title}-{id}' 字段，但并未在下载核心中使用。	在 segmentWorker.ts 中引入 src/main/service/util.ts 的 tplName，在命名最终文件时应用模板。
错误提醒与事件总线	前端只通过 try/catch 捕获，主进程有 eventBus.js。	在主进程的 IPC 路由中，将核心服务的错误捕获，并通过 EventBus 发送给渲染进程，实现统一的错误弹窗（含错误码和建议）。

导出到 Google 表格
三、Fluent Design 样式完善要点
为了更好地贴合 Fluent Design 风格，建议在现有 React/Fluent UI 基础上进行以下改进：

动态主题色：MainLayout.tsx 已读取 accentColor 并应用主题，但 Dropdown、Button 等组件需要确保使用了 Fluent UI 的 Primary 强调色。

分层与阴影：

在 TaskCard (DownloadPage.tsx 中的任务项) 上，添加细微的 Fluent 风格阴影/边框，以营造“浮起”的分层感。

在 SearchPage 的解析结果容器上，使用 Fluent UI 的 Card 或类似的容器组件，突出内容区域。

导航栏切换：

侧边栏的折叠/展开逻辑已经实现，但在实际的 MainLayout.tsx（非组件）中使用了标准的 Link 和 nav 标签。建议统一使用 Fluent UI 的 Nav 和 NavItem，并利用 transition 属性来增加切换时的动画效果。




